---
title: Montando mi propio clúster de K3s HA en Proxmox
author: Xabierland
description: >-
    Aprende a instalar y trabajar con K3s
date: 2025-04-27 10:04
categories: [Tutorial, HomeLab]
tags: [Kubernetes, Containers]
---

## Introducción

## Configuración

### 0. Planificación

Mi idea ahora es montar un clúster de K3s en Proxmox con alta disponibilidad (HA).
En este caso, el cluster constará de 9 nodos, 3 nodos maestros y 6 nodos workers.
Estos se desplegarán en maquinas virtuales (VM) dentro de Proxmox.
De esta forma mantenemos un numero impar de nodos maestros para evitar la perdida de quorum en caso de que uno de los nodos falle. Esta tabla muestra la distribución de los nodos:

| Tipo de nodo | Nombre   | IP            |
| ------------ | -------- | ------------- |
| Maestro      | Pathos   | 192.168.1.201 |
| Maestro      | Techne   | 192.168.1.202 |
| Maestro      | Sophia   | 192.168.1.203 |
| Worker       | Logos    | 192.168.1.204 |
| Worker       | Ethos    | 192.168.1.205 |
| Worker       | Mythos   | 192.168.1.206 |
| Worker       | Thanatos | 192.168.1.207 |
| Worker       | Chronos  | 192.168.1.208 |
| Worker       | Kairos   | 192.168.1.209 |

Para conseguir un clúster HA, es necesario un LoadBalancer Round Robin que redirija el tráfico a los nodos maestros. En este caso, voy a usar HAProxy dentro de un contenedor LXC en Proxmox. El balanceador de carga se encargará de redirigir el tráfico a los nodos maestros y asegurarse de que el tráfico se distribuya de manera equitativa entre ellos. El LoadBalancer se encontrara en la IP `192.168.1.210`.

Este sera el esquema que voy a seguir:

![K3s HA Cluster](/assets/img/posts/k3s-ha-cluster.png)

### 1. Crear las VMs y contenedores

#### 1.1. Crear las VMs

Todas las VMs que voy a crear van a tener la siguiente configuración en Proxmox:

![k3s-vm1](/assets/img/posts/k3s-vm1.png)
![k3s-vm2](/assets/img/posts/k3s-vm2.png)
![k3s-vm3](/assets/img/posts/k3s-vm3.png)
![k3s-vm4](/assets/img/posts/k3s-vm4.png)
![k3s-vm5](/assets/img/posts/k3s-vm5.png)
![k3s-vm6](/assets/img/posts/k3s-vm6.png)
![k3s-vm7](/assets/img/posts/k3s-vm7.png)

> La razón por la que he decidido usar VMs en vez de contenedores es porque Kubernetes requiere tener acceso a ciertos modulos del kernel y configuraciones del sistema operativo que los contenedores reciben del host. Esto puede causar problemas de compatibilidad y estabilidad en el clúster Proxmox. Por lo tanto, es recomendable usar VMs para evitar estos problemas y asegurar una mejor compatibilidad y estabilidad tanto a nivel de Proxmox como a nivel de Kubernetes.
{: .prompt-tip }

Ahora vamos a instalar Debian 12 en cada una de las VMs. Estos son los pasos que voy a seguir:

![k3s-debian1](/assets/img/posts/k3s-debian1.png)

#### 1.2. Preconfiguración de las VMs

Una vez creada la VM e instalado el sistema operativo nos logueamos como root y ejecutamos los siguientes comandos.

```bash
apt-get update && apt-get dist-upgrade -y && apt-get autoremove -y
apt-get install sudo spice-vdagent -y
echo "k3s ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
reboot
```

#### 1.3. Crear el contenedor LXC

Para crear el contenedor LXC, voy a usar el siguiente comando en Proxmox:

```bash
pct create 210 local:vztmpl/debian-12.7.1-standard_12.7-1_amd64.tar.zst \
    --hostname HAProxy \
    --cores 1 \
    --memory 1024 \
    --swap 0 \
    --net0 name=eth0,bridge=vmbr0,ip=192.168.1.210/24,gw=192.168.1.1 \
    --rootfs local-lvm:8

```

### 2. Configurar un Load Balancer

Lo primero que necesitamos para obtener un clúster HA es un balanceador de carga. En este caso, voy a estar usando HAProxy dentro de un contenedor LXC en Proxmox. Lo primero sera crear este contenedor, en mi caso lo creare con `Debian 12` y le asignare 1 vCPU y 1GB de RAM. Una vez creado el contenedor, lo primero que haremos sera instalar HAProxy y crear un par de reglas para redirigir el tráfico a los nodos de K3s. [^1]

```bash
apt-get update && apt-get dist-upgrade -y && apt-get autoremove -y
apt-get install haproxy -y
```

Ahora modificamos el archivo de configuración de HAProxy `/etc/haproxy/haproxy.cfg` para añadir las siguientes líneas:

```
frontend k3s
    bind *:6443
    mode tcp
    default_backend k3s

backend k3s
    mode tcp
    option tcp-check
    balance roundrobin
    server Pathos 192.168.1.201:6443 check
    server Techne 192.168.1.202:6443 check
    server Sophia 192.168.1.203:6443 check
```

Para aplicar los cambios, reiniciamos HAProxy:

```bash
systemctl restart haproxy
```

### 3. Configurar los nodos server

El primer comando que ejecutaremos sera el de boostraping, es decir, el primer nodo del control plane. En este caso, el nodo `Pathos` sera el primer nodo del control plane. Para ello, ejecutamos el siguiente comando:

```bash
export TOKEN=<mi_token>

curl -sfL https://get.k3s.io | \
  INSTALL_K3S_CHANNEL=stable \
  sh -s - server \
    --cluster-init \
    --token "$TOKEN" \
    --tls-san 192.168.1.210

```

Los siguientes nodos del control plane usaran el siguiente comando para unirse al cluster:

```bash
export TOKEN=<mi_token>

curl -sfL https://get.k3s.io | \
  INSTALL_K3S_CHANNEL=stable \
  sh -s - server \
    --server https://192.168.1.210:6443 \
    --token "$TOKEN" \
```

### 4. Configurar los nodos agent

Los nodos worker se unen al cluster de la siguiente manera:

```bash
export TOKEN=<mi_token>

curl -sfL https://get.k3s.io | \
  INSTALL_K3S_CHANNEL=stable \
  sh -s - agent \
    --server https://192.168.1.210:6443 \
    --token "$TOKEN"

```

### 5. Configurar el Upgrade Plan

## Conclusión

## Bibliografía

[^1]: [The Basic HA Cluster](https://docs.k3s.io/blog/2025/03/10/simple-ha)