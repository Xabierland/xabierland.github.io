---
title: Montando mi propio clúster de K3s HA en Proxmox
author: Xabierland
description: >-
    Aprende a instalar y trabajar con K3s, creando un clúster de alta disponibilidad sobre máquinas virtuales en Proxmox.
date: 2025-04-27 10:04
categories: [Tutorial, HomeLab]
tags: [Kubernetes, Containers, Proxmox, K3s]
---

## Introducción

En este tutorial explicaré cómo crear un clúster de alta disponibilidad (HA) utilizando K3s sobre Proxmox. Kubernetes en su versión ligera, K3s, permite crear rápidamente clústeres robustos y eficientes, ideales para laboratorios caseros o entornos de producción pequeños y medianos.

Utilizaremos Proxmox VE para alojar máquinas virtuales (VMs), sobre las cuales desplegaremos nuestro clúster compuesto por 3 nodos maestros y 6 nodos workers. Además, implementaremos HAProxy para balancear la carga entre los nodos maestros. [^1]

## Configuración

### 0. Planificación

El clúster estará compuesto por 9 nodos: 3 nodos maestros que forman el control plane y 6 nodos workers. Este diseño asegura alta disponibilidad y tolerancia a fallos.

| Tipo de nodo | Nombre   | IP            |
| ------------ | -------- | ------------- |
| Maestro      | Pathos   | 192.168.1.201 |
| Maestro      | Techne   | 192.168.1.202 |
| Maestro      | Sophia   | 192.168.1.203 |
| Worker       | Logos    | 192.168.1.204 |
| Worker       | Ethos    | 192.168.1.205 |
| Worker       | Mythos   | 192.168.1.206 |
| Worker       | Thanatos | 192.168.1.207 |
| Worker       | Chronos  | 192.168.1.208 |
| Worker       | Kairos   | 192.168.1.209 |

Usaremos un balanceador de carga HAProxy desplegado en un contenedor LXC en Proxmox con la IP `192.168.1.210`.

![K3s HA Cluster](/assets/img/posts/k3s-ha-cluster.png)

### 1. Crear las VMs y contenedores

#### 1.1. Crear las VMs

Cada VM tendrá las siguientes especificaciones:

![k3s-vm1](/assets/img/posts/k3s-vm1.png)
![k3s-vm2](/assets/img/posts/k3s-vm2.png)
![k3s-vm3](/assets/img/posts/k3s-vm3.png)
![k3s-vm4](/assets/img/posts/k3s-vm4.png)
![k3s-vm5](/assets/img/posts/k3s-vm5.png)
![k3s-vm6](/assets/img/posts/k3s-vm6.png)
![k3s-vm7](/assets/img/posts/k3s-vm7.png)

La instalación de Debian sera la cotidiana. Aquí añado algunos pasos que pueden ser útiles:

![k3s-debian1](/assets/img/posts/k3s-debian1.png)
![k3s-debian2](/assets/img/posts/k3s-debian2.png)
![k3s-debian3](/assets/img/posts/k3s-debian3.png)

#### 1.2. Preconfiguración de las VMs

Realizamos estos pasos tras la instalación del sistema operativo:

```bash
apt-get update && apt-get dist-upgrade -y && apt-get autoremove -y
apt-get install sudo ssh -y
useradd -m -s /bin/bash k3s
echo "k3s ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# Configuración IP estática (adaptar IP según el nodo)
cat <<EOF > /etc/network/interfaces
auto lo
iface lo inet loopback

auto enp6s18
iface enp6s18 inet static
    address 192.168.1.201
    netmask 255.255.255.0
    gateway 192.168.1.1
    dns-domain xabierland.local
    dns-nameservers 192.168.1.254 1.1.1.1 1.0.0.1
EOF

systemctl restart networking

# Configuración SSH para usuario k3s
mkdir -p /home/k3s/.ssh
chmod 700 /home/k3s/.ssh
wget -qO- https://raw.githubusercontent.com/xabierland/xabierland.github.io/main/assets/keys/xabierland.pub >> /home/k3s/.ssh/authorized_keys
chmod 600 /home/k3s/.ssh/authorized_keys
chown -R k3s:k3s /home/k3s/.ssh

reboot
```

#### 1.3. Crear el contenedor LXC

Creamos el contenedor con HAProxy:

```bash
pct create 210 local:vztmpl/debian-12.7.1-standard_12.7-1_amd64.tar.zst \
    --hostname HAProxy --cores 1 --memory 1024 --swap 0 \
    --net0 name=eth0,bridge=vmbr0,ip=192.168.1.210/24,gw=192.168.1.1 \
    --rootfs local-lvm:8
```

### 2. Configurar el Load Balancer HAProxy

Instalamos HAProxy y configuramos:

```bash
apt-get update && apt-get dist-upgrade -y
apt-get install haproxy -y
```

Configuramos `/etc/haproxy/haproxy.cfg`:

```haproxy
frontend k3s
    bind *:6443
    mode tcp
    default_backend k3s

backend k3s
    mode tcp
    option tcp-check
    balance roundrobin
    server Pathos 192.168.1.201:6443 check
    server Techne 192.168.1.202:6443 check
    server Sophia 192.168.1.203:6443 check
```

Reiniciamos el servicio:

```bash
systemctl restart haproxy
```

### 3. Configurar los nodos server

Inicializamos el primer nodo del clúster (`Pathos`):

```bash
export TOKEN="<mi_token>"
curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=stable sh -s - server \
  --cluster-init --token "$TOKEN" --tls-san 192.168.1.210

mkdir -p ~/.kube
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
sudo chown $USER:$USER ~/.kube/config
echo "export KUBECONFIG=~/.kube/config" >> ~/.bashrc
source ~/.bashrc
```

Copiamos el `kubeconfig` a nuestra máquina local:

```bash
scp k3s@192.168.1.201:/home/k3s/.kube/config ~/.kube/config
```

Agregamos los nodos maestros restantes (`Techne`, `Sophia`):

```bash
export TOKEN="<mi_token>"
curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=stable sh -s - server \
  --server https://192.168.1.210:6443 --token "$TOKEN"
```

### 4. Configurar los nodos worker

Para unir los nodos worker al clúster ejecutamos:

```bash
export TOKEN="<mi_token>"
curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=stable sh -s - agent \
  --server https://192.168.1.210:6443 --token "$TOKEN"
```

### 5. Configurar el Upgrade Plan

Implementaremos un plan de actualizaciones periódicas usando Rancher System Upgrade Controller, garantizando la estabilidad y seguridad del clúster.

```bash
kubectl apply -f https://github.com/rancher/system-upgrade-controller/releases/latest/download/system-upgrade-controller.yaml
kubectl apply -f https://github.com/rancher/system-upgrade-controller/releases/latest/download/crd.yaml

kubectl apply -f - <<EOF
# Server plan
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: server-plan
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: true
  nodeSelector:
    matchExpressions:
    - key: node-role.kubernetes.io/control-plane
      operator: In
      values:
      - "true"
  serviceAccountName: system-upgrade
  upgrade:
    image: rancher/k3s-upgrade
  channel: https://update.k3s.io/v1-release/channels/stable
---
# Agent plan
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: agent-plan
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: true
  nodeSelector:
    matchExpressions:
    - key: node-role.kubernetes.io/control-plane
      operator: DoesNotExist
  prepare:
    args:
    - prepare
    - server-plan
    image: rancher/k3s-upgrade
  serviceAccountName: system-upgrade
  upgrade:
    image: rancher/k3s-upgrade
  channel: https://update.k3s.io/v1-release/channels/stable
---
EOF
```

## Conclusión

Siguiendo estos pasos obtendremos un clúster K3s robusto y con alta disponibilidad sobre Proxmox, facilitando futuras escalabilidades, actualizaciones y mantenimiento.

## Bibliografía

[^1]: [K3s HA Cluster Official Documentation](https://docs.k3s.io/blog/2025/03/10/simple-ha)
